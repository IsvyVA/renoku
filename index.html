<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>ReNoKu</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="ReNoKu">
<link rel="apple-touch-icon" href="icon-192.png">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    @font-face {
        font-family: "Comfortaa";
        src: url("fonts/comfortaa.woff2") format("woff2");
    }

    body {
        font-family: Comfortaa, sans-serif;
        background: #f4f4f4;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 10px;
    }

    #gameContainer {
        width: 100%;
        max-width: 500px;
    }

    #board {
        display: grid;
        grid-template-columns: repeat(9, 1fr);
        width: 100%;
        aspect-ratio: 1;
        border: 4px solid black;
    }

    .cell {
        position: relative;
        border: 1px solid #bbb;
    }

    .cell input {
        width: 100%;
        height: 100%;
        font-size: clamp(16px, 5vw, 24px);
        text-align: center;
        border: none;
        background: white;
    }

    .cell input:focus {
        outline: none;
        background-color: #e3f2fd;
    }

    .box-right {
        border-right: 3px solid black !important;
    }

    .box-bottom {
        border-bottom: 3px solid black !important;
    }

    .fixed input {
        background-color: #e0e0e0;
        font-weight: bold;
    }

    h1 {
        font: weight 700;
        margin-bottom: 10px;
    }

    .title {
        text-align: center;
        width: 100%;
    }

    input {
        width: 50px;
        height: 50px;
        text-align: center;
        font-size: 20px;
        border: 1px solid #999;
    }

    input:focus {
        outline: none;
        background-color: #e0f7fa;
    }

    .fixed {
        background-color: #ddd;
        font-weight: bold;
    }

    /* Erro tem prioridade absoluta */
    .cell.error input,
    .cell.selected.error input,
    .cell.highlight.error input,
    .cell.fixed.error input {
        background-color: #ff3d3d !important;
        color: #fff !important;
    }

    .box-border-right {
        border-right: 3px solid black;
    }

    .box-border-bottom {
        border-bottom: 3px solid black;
    }

    button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }

    .start-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .start-btn {
        display: block;
        margin: 20px auto;
    }

    #victoryScreen {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;

        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    #victoryScreen.active {
        opacity: 1;
        pointer-events: all;
    }

    .victory-content {
        background: white;
        padding: 40px;
        border-radius: 16px;
        text-align: center;
        max-width: 300px;
        animation: pop 0.3s ease;
    }

    .victory-content h2 {
        margin-bottom: 10px;
    }

    .victory-content button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
    }

    @keyframes pop {
        from {
            transform: scale(0.8);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .pause-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 900;

        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .pause-overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    .pause-box {
        background: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
    }

    /* Input padr√£o */
    .cell input {
        width: 100%;
        height: 100%;
        text-align: center;
        font-size: clamp(16px, 5vw, 24px);
        border: none;
        background-color: white; /* fundo default para c√©lulas digit√°veis */
        transition: background 0.2s;
        color: black; /* texto padr√£o */
    }

    /* C√©lulas fixas (pr√©-preenchidas) */
    .cell.fixed input {
        background-color: #e0e0e0; /* cinza */
        font-weight: bold;
        color: #555; /* texto mais escuro */
    }

    /* Linha/coluna destacada */
    .cell.highlight input {
        background-color: #eef6ff;
    }

    /* C√©lula selecionada */
    .cell.selected input {
        background-color: #cde7ff;
    }

    /* Se for fixa e estiver destacada, mant√©m o cinza mas adiciona borda ou leve overlay */
    .cell.fixed.highlight input {
        background-color: #d4d9e6; /* cinza claro com destaque */
    }

    .cell.fixed.selected input {
        background-color: #bfc8e0; /* cinza mais forte para c√©lula selecionada */
    }

    #profile-btn {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background-color: #4caf50;
        color: white;
        border: none;
        font-weight: bold;
        z-index: 1000;
    }

    #profile {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        z-index: 1000;
    }

    .hidden { display: none; }

    #badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .badge {
        background-color: #ffd700;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        font-weight: bold;
        color: #333;
        flex-shrink: 0;
        text-align: center;
    }

    @media (max-width: 600px) {
        #gameContainer {
            max-width: 100vw;
            padding: 0;
        }
        .victory-content, .pause-box, #profile {
            padding: 1rem;
            max-width: 98vw;
        }
        #profile {
            font-size: 0.95em;
        }
        .badge {
            font-size: 0.9em;
            padding: 0.4rem 0.7rem;
        }
        h1.title {
            font-size: 1.5em;
        }
    }
</style>
</head>

<body>
<div id="gameContainer">
    <!-- Dificuldade, timer, bot√µes -->
    <div style="padding-bottom: 0.5em;">
        <h1 class="title">ReNoKu</h1>
    </div>
    <div>
        <label>Dificuldade: </label>
        <select id="difficulty">
            <option value="easy">F√°cil</option>
            <option value="medium" selected>M√©dio</option>
            <option value="hard">Dif√≠cil</option>
        </select>

        <span style="margin-left:20px;">
            ‚è±Ô∏è Tempo: <strong id="timer">00:00</strong>
        </span>
    </div>
    <div style="padding-bottom: 0.5em;">
        <button onclick="toggleNotes()" id="notesBtn">‚úèÔ∏è Modo Marca√ß√µes: OFF</button>
        <button onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è Pausar</button>
    </div>
    <!-- Tabuleiro -->
    <div id="board"></div>
    <button class="start-btn" onclick="startGame()">Nova Partida</button>

    <!-- Bot√£o para abrir o perfil -->
    <button id="profile-btn">Perfil</button>

    <!-- Tela do perfil -->
    <div id="profile" class="hidden">
        <h2>Perfil de <span id="player-name">Ela</span></h2>
        
        <div class="stats">
            <p>Partidas jogadas: <span id="games-played">0</span></p>
            <p>Melhor tempo (F√°cil): <span id="best-time-easy">--:--</span></p>
            <p>Melhor tempo (M√©dio): <span id="best-time-medium">--:--</span></p>
            <p>Melhor tempo (Dif√≠cil): <span id="best-time-hard">--:--</span></p>
        </div>

        <h3>Frases desbloqueadas:</h3>
        <div id="badges">
            <!-- badges aparecer√£o aqui -->
        </div>

        <button onclick="closeProfile()">Fechar</button>
    </div>

</div>

<script>
const N = 9;
let solution = [];
let timerInterval;
let seconds = 0;
let notesMode = false;
let isPaused = false;

const romanticMessages = [
    "Voc√™ √© minha campe√£ para sempre ‚ô•Ô∏è",
    "A vida s√≥ √© boa porque voc√™ est√° ao meu lado!",
    "Vencedendo aqui do mesmo jeito que vencemos a dist√¢ncia",
    "Meu pr√™mio maior √© ter voc√™ comigo ‚ô•Ô∏è",
    "Nada melhor que acordar ao seu lado!",
    "Assim que tem que ser! Se jogou, nen√©m tem que vencer!",
    "Bora comemorar com um amorzinho? üòè",
    "Nada como minha plantinha crescendo! üå±",
    "Hora de coroar minha abelhinha vitoriosa üêù",
    "Tome meu amor, deixou cair sua üëë",
    "Medalha de ouro nas olimpiadas de Sudoku ü•á",
    "Demorou de mais, o velhinho do lado fez mais r√°pido üë¥üèº",
    "Vit√≥ria! A recompensa √© um descanso no peitinho",
    "Mikey aprova essa partida üëÑ",
    "Que bom meu amor! Te amo üòò",
    "Voc√™ consegue amor, um pouco mais e j√° n√£o mais separa√ß√£o ‚ô•Ô∏è",
    "Voc√™ √© o sol dos meus dias e lua das minhas noites",
    "Chucu Chucu venceu üôåüèª! Chucu Chucu vencedor!"
];

// Perfil do jogador
const PROFILE_KEY = "renoku-profile";
const defaultProfile = {
    gamesPlayed: 0,
    bestTimes: { easy: null, medium: null, hard: null },
    badges: []
};
let profile = null;

const badgeList = [
    { key: "primeira", label: "Primeira vit√≥ria!" },
    { key: "5games", label: "5 partidas jogadas!" },
    { key: "rapido_easy", label: "Menos de 2min (F√°cil)" },
    { key: "rapido_medium", label: "Menos de 3min (M√©dio)" },
    { key: "rapido_hard", label: "Menos de 5min (Dif√≠cil)" }
];

function formatTime(sec) {
    let m = Math.floor(sec / 60);
    let s = sec % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

function togglePause() {
    if (!isPaused) {
        pauseGame();
    }
}

function pauseGame() {
    isPaused = true;
    clearInterval(timerInterval);

    document.querySelectorAll("#board input").forEach(input => {
    input.disabled = true;
});

    document.getElementById("pauseOverlay").classList.add("active");}

function resumeGame() {
    isPaused = false;

    timerInterval = setInterval(() => {
        seconds++;
        document.getElementById("timer").innerText = formatTime(seconds);
    }, 1000);

    document.getElementById("pauseOverlay").classList.remove("active");

    document.querySelectorAll("#board input").forEach(input => {
        if (!input.classList.contains("fixed")) {
            input.disabled = false;
        }
    });
}

function startTimer() {
    seconds = 0;
    document.getElementById("timer").innerText = "00:00";
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        seconds++;
        document.getElementById("timer").innerText = formatTime(seconds);
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}

function isValid(board, row, col, num) {
    for (let x = 0; x < N; x++) {
        if (board[row][x] === num) return false;
        if (board[x][col] === num) return false;
    }

    let startRow = row - row % 3;
    let startCol = col - col % 3;

    for (let i = 0; i < 3; i++)
        for (let j = 0; j < 3; j++)
            if (board[startRow + i][startCol + j] === num) return false;

    return true;
}

function solve(board) {
    for (let row = 0; row < N; row++) {
        for (let col = 0; col < N; col++) {
            if (board[row][col] === 0) {
                let nums = [...Array(9).keys()].map(x => x + 1);
                shuffle(nums);

                for (let num of nums) {
                    if (isValid(board, row, col, num)) {
                        board[row][col] = num;
                        if (solve(board)) return true;
                        board[row][col] = 0;
                    }
                }
                return false;
            }
        }
    }
    return true;
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function generateFullBoard() {
    let board = Array.from({ length: 9 }, () => Array(9).fill(0));
    solve(board);
    return board;
}

function removeNumbers(board, difficulty) {
    let puzzle = board.map(row => [...row]);
    let removeCount = difficulty === "easy" ? 30 :
                      difficulty === "medium" ? 40 : 50;

    while (removeCount > 0) {
        let row = Math.floor(Math.random() * 9);
        let col = Math.floor(Math.random() * 9);
        if (puzzle[row][col] !== 0) {
            puzzle[row][col] = 0;
            removeCount--;
        }
    }

    return puzzle;
}

function checkWin() {
    const inputs = document.querySelectorAll("#board input");
    let index = 0;

    for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
            let value = parseInt(inputs[index].value);
            if (value !== solution[row][col]) return false;
            index++;
        }
    }

    stopTimer();
    let randomMessage = romanticMessages[Math.floor(Math.random() * romanticMessages.length)];
    showVictoryScreen(randomMessage);
    return true;
}

function toggleNotes() {
    notesMode = !notesMode;
    document.getElementById("notesBtn").innerText =
        notesMode ? "‚úèÔ∏è Modo Marca√ß√µes: ON" : "‚úèÔ∏è Modo Marca√ß√µes: OFF";
}

function addNote(cell, number) {
    let notes = cell.querySelector(".notes");

    if (!notes) {
        notes = document.createElement("div");
        notes.classList.add("notes");
        notes.style.position = "absolute";
        notes.style.top = "2px";
        notes.style.left = "2px";
        notes.style.right = "2px";
        notes.style.bottom = "2px";
        notes.style.fontSize = "10px";
        notes.style.display = "grid";
        notes.style.gridTemplateColumns = "repeat(3, 1fr)";
        notes.style.pointerEvents = "none";
        cell.appendChild(notes);

        for (let i = 1; i <= 9; i++) {
            let span = document.createElement("span");
            span.dataset.number = i;
            notes.appendChild(span);
        }
    }

    let target = notes.querySelector(`[data-number='${number}']`);
    target.innerText = target.innerText ? "" : number;
}

function showVictoryScreen(message) {
    document.getElementById("finalTime").innerText =
        `‚è±Ô∏è Tempo: ${formatTime(seconds)}`;
    document.getElementById("romanticText").innerText = message;
    document.getElementById("victoryScreen").classList.add("active");
    updateProfileAfterWin();
}

function renderBoard(puzzle) {
    const boardDiv = document.getElementById("board");
    boardDiv.innerHTML = "";

    for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
            let cell = document.createElement("div");
            cell.classList.add("cell");
            cell.dataset.row = row;
            cell.dataset.col = col;

            let input = document.createElement("input");
            input.type = "tel";
            input.inputMode = "numeric";
            input.pattern = "[1-9]";
            input.maxLength = 1;

            // Salva valor atual da c√©lula no dataset
            cell.dataset.value = puzzle[row][col] !== 0 ? puzzle[row][col] : "";

            if (puzzle[row][col] !== 0) {
                input.value = puzzle[row][col];
                input.disabled = true;
                cell.classList.add("fixed");
            } else {
                input.value = "";
                input.addEventListener("input", function () {
                    let val = parseInt(this.value);
                    if (!val || val < 1 || val > 9) {
                        this.value = "";
                        cell.dataset.value = "";
                        return;
                    }
                    if (notesMode) {
                        addNote(cell, val);
                        this.value = "";
                        return;
                    }
                    cell.dataset.value = val;
                    if (val !== solution[row][col]) {
                        cell.classList.add("error");
                    } else {
                        cell.classList.remove("error");
                        let notes = cell.querySelector(".notes");
                        if (notes) notes.remove();
                        // Verifica vit√≥ria
                        if (checkWin()) return;
                    }
                });
            }

            cell.appendChild(input);
            cell.addEventListener("click", () => selectCell(row, col));
            input.addEventListener("focus", () => selectCell(row, col));

            if ((col + 1) % 3 === 0 && col !== 8) cell.classList.add("box-right");
            if ((row + 1) % 3 === 0 && row !== 8) cell.classList.add("box-bottom");

            boardDiv.appendChild(cell);
        }
    }
}

function selectCell(row, col) {
    // limpa sele√ß√µes antigas
    document.querySelectorAll(".cell").forEach(c => {
        c.classList.remove("selected", "highlight");
    });

    const selectedCell = document.querySelector(`.cell[data-row='${row}'][data-col='${col}']`);
    selectedCell.classList.add("selected");

    // destaca linha e coluna
    document.querySelectorAll(".cell").forEach(c => {
        const cellRow = Number(c.dataset.row);
        const cellCol = Number(c.dataset.col);
        if (cellRow === row || cellCol === col) {
            c.classList.add("highlight");
        }
    });
}

function startGame() {
    document.getElementById("victoryScreen").classList.remove("active");
    const difficulty = document.getElementById("difficulty").value;
    solution = generateFullBoard();
    // Deep copy solution to avoid mutating on removeNumbers
    let solutionCopy = solution.map(row => row.slice());
    let puzzle = removeNumbers(solutionCopy, difficulty);
    renderBoard(puzzle);
    startTimer();
    // Atualiza perfil de partidas jogadas
    profile.gamesPlayed = (profile.gamesPlayed || 0) + 1;
    saveProfile();
}

//---------------------- PERFIL do jogador --------------------------
function loadProfile() {
    let stored = localStorage.getItem(PROFILE_KEY);
    if (stored) {
        try {
            profile = JSON.parse(stored);
        } catch {
            profile = { ...defaultProfile };
        }
    } else {
        profile = { ...defaultProfile };
    }
    showProfile();
}

function saveProfile() {
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
}

function showProfile() {
    document.getElementById("games-played").innerText = profile.gamesPlayed || 0;
    ["easy", "medium", "hard"].forEach(diff => {
        let el = document.getElementById("best-time-" + diff);
        if (profile.bestTimes && profile.bestTimes[diff]) {
            el.innerText = formatTime(profile.bestTimes[diff]);
        } else {
            el.innerText = "--:--";
        }
    });
    // badges/frases
    const badgesDiv = document.getElementById("badges");
    badgesDiv.innerHTML = "";
    (profile.badges||[]).forEach(key => {
        let badgeData = badgeList.find(b => b.key === key);
        if (badgeData) {
            let div = document.createElement("div");
            div.className = "badge";
            div.innerText = badgeData.label;
            badgesDiv.appendChild(div);
        }
    });
}

function unlockBadge(key) {
    if (!profile.badges) profile.badges = [];
    if (!profile.badges.includes(key)) {
        profile.badges.push(key);
        saveProfile();
        showProfile();
    }
}

function updateProfileAfterWin() {
    // Atualiza melhor tempo
    let difficulty = document.getElementById("difficulty").value;
    if (!profile.bestTimes) profile.bestTimes = {};
    if (!profile.bestTimes[difficulty] || seconds < profile.bestTimes[difficulty]) {
        profile.bestTimes[difficulty] = seconds;
    }
    // Badges
    if (!(profile.badges||[]).includes("primeira")) unlockBadge("primeira");
    if (profile.gamesPlayed >= 5) unlockBadge("5games");
    if (difficulty === "easy" && seconds <= 120) unlockBadge("rapido_easy");
    if (difficulty === "medium" && seconds <= 180) unlockBadge("rapido_medium");
    if (difficulty === "hard" && seconds <= 300) unlockBadge("rapido_hard");
    saveProfile();
    showProfile();
}

// Bot√£o perfil
document.getElementById("profile-btn").addEventListener("click", function() {
    showProfile();
    document.getElementById("profile").classList.remove("hidden");
});
function closeProfile() {
    document.getElementById("profile").classList.add("hidden");
}

// Inicializa√ß√£o
window.addEventListener("DOMContentLoaded", () => {
    loadProfile();
});

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js")
    .then(() => console.log("Service Worker registrado"))
    .catch(err => console.log("Erro SW:", err));
}
</script>

<div id="pauseOverlay" class="pause-overlay">
    <div class="pause-box">
        <h2>‚è∏Ô∏è ReNoKu pausado</h2>
        <p>Respira, meu amor üòå</p>
        <button onclick="resumeGame()">‚ñ∂Ô∏è Continuar</button>
    </div>
</div>

<div id="victoryScreen">
    <div class="victory-content">
        <h2>üèÜ Parab√©ns meu amor!</h2>
        <p id="finalTime"></p>
        <p id="romanticText"></p>
        <button onclick="startGame()">Jogar Novamente</button>
    </div>
</div>

</body>
</html>